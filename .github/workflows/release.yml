name: Release Pipeline

on:
  push:
    branches:
      - main        # ÁõëÂê¨ main ÂàÜÊîØÁöÑÊôÆÈÄöÊèê‰∫§ÔºàÂè™ÊµãËØïÊûÑÂª∫Ôºâ
    tags:
      - 'v*'        # ÁõëÂê¨ÊâìÊ†áÁ≠æÔºàÊâßË°åÂèëÂ∏ÉÔºâ
  workflow_dispatch: # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë

permissions:
  contents: write

jobs:
  # ========================================================
  # Job 1: ÊûÑÂª∫ÊµãËØï (Build Test)
  # Âú∫ÊôØ: Âè™ÊòØ Push ‰ª£Á†ÅÂà∞ main ÂàÜÊîØÔºåÊ≤°ÊúâÊâì Tag
  # ÁõÆÁöÑ: Á°Æ‰øù‰ª£Á†ÅËÉΩÁºñËØëÈÄöËøáÔºå‰ΩÜ‰∏çÊ∂àËÄóÁâàÊú¨Âè∑Ôºå‰∏çÂèëÂ∏É
  # ========================================================
  test-build:
    # Â¶ÇÊûú‰∏çÊòØ TagÔºå‰∏î‰∏çÊòØÊâãÂä®Ëß¶ÂèëÔºåÂàôËøêË°åÊµãËØï
    if: startsWith(github.ref, 'refs/tags/') != true
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build only (No Release)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: dW50cnVzdGVkIGNvbW1lbnQ6IHJzaWduIGVuY3J5cHRlZCBzZWNyZXQga2V5ClJXUlRZMEl5UW5Nb3ZvRnFVL25mNmRRQ2FDZE9rRzlYaHhEWkxOQ0x2OERRL09aTm9BWUFBQkFBQUFBQUFBQUFBQUlBQUFBQUsydjdtdkdpVWQ4dTcxS1Z4K0F0Q3VCQXZ3K01BcnhvUThTLzZ1NGlQbkxpK1dUYVZUbndCTG5LaE9ZQ0JvY0FlYTk1aDB0TkxHc3FFVDBnOS8zL3dFWTRndHNUUzlVbG12LzVNSFpscG4yTkZhWk5ZbUxwMUdLNlE5NVFXR09qa09DcUd5ZVBMeHM9Cg==
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""
        run: npm run tauri build

  # ========================================================
  # Job 2: Ê≠£ÂºèÂèëÂ∏É (Release)
  # Âú∫ÊôØ: Êé®ÈÄÅ‰∫Ü v* Ê†áÁ≠æ
  # ÁõÆÁöÑ: ÁîüÊàêÊõ¥Êñ∞Êó•Âøó„ÄÅÁ≠æÂêç„ÄÅÊâìÂåÖ„ÄÅ‰∏ä‰º† Release
  # ========================================================
  release:
    # Âè™ÊúâÂΩìÊé®ÈÄÅÁöÑÊòØ Tag Êó∂ÊâçËøêË°å
    if: startsWith(github.ref, 'refs/tags/')
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows-latest
            args: ''

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        shell: bash
        run: |
          # Ëé∑ÂèñÂΩìÂâç tag
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          echo "Current tag: $CURRENT_TAG"

          # Ëé∑Âèñ‰∏ä‰∏Ä‰∏™ tag
          PREV_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
          echo "Previous tag: $PREV_TAG"

          # Ëé∑Âèñ commit ÂàóË°®
          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s" -50)
          else
            COMMITS=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"%s")
          fi

          # ÂàÜÁ±ª commits
          FEATURES=""
          FIXES=""
          UPDATES=""
          OTHERS=""

          while IFS= read -r line; do
            [ -z "$line" ] && continue

            if echo "$line" | grep -qiE "^feat[Ôºö:]"; then
              FEATURES="${FEATURES}- ${line#*[Ôºö:]}"$'\n'
            elif echo "$line" | grep -qiE "^(fix|bugfix|bug)[Ôºö:]"; then
              FIXES="${FIXES}- ${line#*[Ôºö:]}"$'\n'
            elif echo "$line" | grep -qiE "^(update|improve|perf|‰ºòÂåñ)[Ôºö:]"; then
              UPDATES="${UPDATES}- ${line#*[Ôºö:]}"$'\n'
            elif echo "$line" | grep -qiE "^(chore|docs|refactor|style|test|security)[Ôºö:]"; then
              OTHERS="${OTHERS}- ${line#*[Ôºö:]}"$'\n'
            else
              OTHERS="${OTHERS}- ${line}"$'\n'
            fi
          done <<< "$COMMITS"

          # ÊûÑÂª∫ changelog
          CHANGELOG=""

          if [ -n "$FEATURES" ]; then
            CHANGELOG="${CHANGELOG}## ‚ú® Êñ∞ÂäüËÉΩ"$'\n'"${FEATURES}"$'\n'
          fi

          if [ -n "$FIXES" ]; then
            CHANGELOG="${CHANGELOG}## üêõ Bug ‰øÆÂ§ç"$'\n'"${FIXES}"$'\n'
          fi

          if [ -n "$UPDATES" ]; then
            CHANGELOG="${CHANGELOG}## üöÄ ‰ºòÂåñÊîπËøõ"$'\n'"${UPDATES}"$'\n'
          fi

          if [ -n "$OTHERS" ]; then
            CHANGELOG="${CHANGELOG}## üì¶ ÂÖ∂‰ªñ"$'\n'"${OTHERS}"$'\n'
          fi

          # Â¶ÇÊûúÊ≤°Êúâ‰ªª‰ΩïÂàÜÁ±ªÁöÑ commits
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Êú¨Ê¨°Êõ¥Êñ∞Êó†ÈáçÂ§ßÂèòÊõ¥"$'\n'
          fi

          # ËæìÂá∫Âà∞ GitHub Actions
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build and release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: dW50cnVzdGVkIGNvbW1lbnQ6IHJzaWduIGVuY3J5cHRlZCBzZWNyZXQga2V5ClJXUlRZMEl5UW5Nb3ZvRnFVL25mNmRRQ2FDZE9rRzlYaHhEWkxOQ0x2OERRL09aTm9BWUFBQkFBQUFBQUFBQUFBQUlBQUFBQUsydjdtdkdpVWQ4dTcxS1Z4K0F0Q3VCQXZ3K01BcnhvUThTLzZ1NGlQbkxpK1dUYVZUbndCTG5LaE9ZQ0JvY0FlYTk1aDB0TkxHc3FFVDBnOS8zL3dFWTRndHNUUzlVbG12LzVNSFpscG4yTkZhWk5ZbUxwMUdLNlE5NVFXR09qa09DcUd5ZVBMeHM9Cg==
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""
        with:
          tagName: v__VERSION__
          releaseName: 'v__VERSION__'
          releaseBody: |
            ${{ steps.changelog.outputs.changelog }}
          releaseDraft: false
          prerelease: false
          includeUpdaterJson: true
          args: ${{ matrix.args }}
